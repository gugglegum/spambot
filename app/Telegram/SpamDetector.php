<?php

namespace App\Telegram;

use App\Helpers\TelegramHelper;
use Telegram\Bot\Objects\Message;

class SpamDetector
{
    private \Aura\Sql\ExtendedPdo $pdo;
    private Message $message;

    /** @var float Big positive values for good messages from trusted senders, small or negative values for bad messages from untrusted senders */
    public float $rate = 0.0;
    public int $messagesCountFromUser;
    public ?int $dateOfFirstUserMessage;
    public ?float $daysSinceFirstMessage;

    public SpamDetectorBadWordsStat $badWordStat;

    public function __construct(\Aura\Sql\ExtendedPdo $pdo, Message $message, SpamDetectorBadWordsStat $badWordStat = null)
    {
        $this->pdo = $pdo;
        $this->message = $message;
        if ($badWordStat) {
            $this->badWordStat = $badWordStat;
        }
    }

    public function rate(): void
    {
        $chatId = TelegramHelper::convertChatId($this->message->chat->id, $this->message->chat->type);
        $messageFromId = TelegramHelper::getMessageFromId($this->message);

        $this->messagesCountFromUser = $this->getMessagesCountFromUser($messageFromId, $chatId, $this->message->messageId);
        $this->dateOfFirstUserMessage = $this->getDateOfFirstUserMessage($messageFromId, $chatId);
        $this->daysSinceFirstMessage = $this->dateOfFirstUserMessage ? ($this->message->date - $this->dateOfFirstUserMessage) / 3600 / 24 : null;

//        $this->rateMessagesCount();
//        $this->rateDateOfFirstUserMessage();
        $this->rateBadWords();
        $this->rateMixedLetters();
        $this->rateMaskedDigits();
    }

    private function rateMessagesCount(): void
    {
        if ($this->messagesCountFromUser > 0) {
            $rate = log($this->messagesCountFromUser + 9, 10) * 10;
        } else {
            $rate = 0;
        }
        echo "rateMessagesCount: " . round($rate, 2) . "\n";
        $this->rate += $rate;
    }

    private function rateDateOfFirstUserMessage(): void
    {
        if ($this->dateOfFirstUserMessage) {
            if ($this->daysSinceFirstMessage > 0) {
                $rate = log($this->daysSinceFirstMessage + 9, 10) * 10;
            } else {
                $rate = 0;
            }
        } else {
            $rate = 0;
        }
        echo "rateDateOfFirstUserMessage: " . round($rate, 2) . "\n";
        $this->rate += $rate;
    }

    private function rateBadWords(): void
    {
        $words = self::extractWords((string) $this->message->text);
        //var_dump($words);
        $badWordSequences = [
            ['Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€ÑÑ‚Ð²Ð¾', -10],
            ['(Ð¸Ñ‰(Ñƒ|ÐµÐ¼)|Ð½ÑƒÐ¶Ð½Ñ‹|Ð½Ð°Ð±Ð¾Ñ€|Ð½Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼) Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€(Ñ‹|Ð¾Ð²)', -10],
            ['(Ð½Ð°Ð±Ð¾Ñ€|Ð½ÑƒÐ¶Ð½Ñ‹|Ð½Ð°Ð±Ð¸Ñ€Ð°ÑŽ|Ð½Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼)( (Ð»ÑŽÐ´Ð¸|Ð»ÑŽÐ´ÐµÐ¹))?( Ð½Ð¾Ð²ÑƒÑŽ)?( Ð²)? ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ', -10],
            ['(Ð»ÑŽÐ´ÐµÐ¹|Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°)(( Ðº)? ÑÐµÐ±Ðµ)? Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ', -10],
            ['(Ð½ÑƒÐ¶(Ð½Ñ‹|ÐµÐ½|Ð¾)|Ð¸Ñ‰(Ñƒ|ÐµÐ¼)) \d+ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°?', -10],
            ['Ð»ÑŽÐ´(Ð¸|ÐµÐ¹) Ð´Ð»Ñ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°', -10],
            ['Ð½Ð°Ð±Ð¸Ñ€Ð°ÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€Ð¾Ð²', -10],
            ['Ðº Ð½Ð°ÑˆÐµÐ¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ', -10],
            ['Ð¸Ñ‰Ñƒ Ð»ÑŽÐ´ÐµÐ¹ Ð² ÑÑ„ÐµÑ€Ñƒ ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹', -10],
            ['Ð¸Ñ‰(Ñƒ|ÐµÐ¼) ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº(Ð¾Ð²|Ð°)', -10],
            ['Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ Ð»ÑŽÐ´Ð¸', -10],
            ['Ð½ÑƒÐ¶Ð½Ñ‹ Ð»ÑŽÐ´Ð¸', -10],
            ['Ð½Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð»ÑŽÐ´ÐµÐ¹ Ð½Ð° ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾', -10],
            ['Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð°', -10],
            ['Ð²( Ð½Ð¾Ð²Ð¾Ð¼)? Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ P2P', -10],
            ['Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ Ð½ÑƒÐ»Ñ', -10],
            ['(Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾(Ðµ)?|ÐµÑÑ‚ÑŒ|Ð²ÑÐµÐ¼Ñƒ) Ð¾Ð±ÑƒÑ‡(Ð¸Ð¼|Ð°ÐµÐ¼|ÐµÐ½Ð¸Ðµ)', -10],
            ['Ð¾Ð±ÑƒÑ‡(Ð¸Ð¼|Ð°ÐµÐ¼|ÐµÐ½Ð¸Ðµ)( Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ| Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ð¾| ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ð¾)? Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾(Ðµ)?', -10],
            ['ÑƒÐ´Ð°Ð»ÐµÐ½Ð½(Ð°Ñ|ÑƒÑŽ) (Ð¿Ð¾Ð´Ñ€Ð°Ð±Ð¾Ñ‚Ðº(Ð°|Ñƒ)|Ñ€Ð°Ð±Ð¾Ñ‚(Ð°|Ñƒ))', -10],
            ['(Ñ€Ð°Ð±Ð¾Ñ‚Ð°|Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚ÑŒ) ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð°Ñ', -10],
            ['ÑƒÐ´Ð°Ð»ÐµÐ½Ð½(Ð¾Ð³Ð¾|Ñ‹Ð¹) Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚(ÐºÐ°|Ð¾Ðº)', -10],
            ['ÐµÑÑ‚ÑŒ Ð¿Ð¾Ð´Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°', -10],
            ['Ð¿Ð¾Ð´Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¾Ð½Ð½Ð¾', -10],
            ['(Ð¾Ñ‚|Ð´Ð¾) \d{2,6}\s?(\$|USDT?|EUR|Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²|Ñ€ÑƒÐ±(Ð»ÐµÐ¹)?)( Ð²)? (Ð½ÐµÐ´|Ð½ÐµÐ´ÐµÐ»ÑŽ|Ð´|Ð´ÐµÐ½ÑŒ|ÑÑƒÑ‚|ÑÑƒÑ‚ÐºÐ¸|Ð¼ÐµÑ|Ð¼ÐµÑÑÑ†)', -10],
            ['(Ð¾Ñ‚|Ð´Ð¾) \$\s?\d{2,6}( Ð²)? (Ð½ÐµÐ´|Ð½ÐµÐ´ÐµÐ»ÑŽ|Ð´|Ð´ÐµÐ½ÑŒ|ÑÑƒÑ‚|ÑÑƒÑ‚ÐºÐ¸|Ð¼ÐµÑ|Ð¼ÐµÑÑÑ†)', -10],
            ['Ð² (Ð½ÐµÐ´|Ð½ÐµÐ´ÐµÐ»ÑŽ|Ð´|Ð´ÐµÐ½ÑŒ|ÑÑƒÑ‚|ÑÑƒÑ‚ÐºÐ¸|Ð¼ÐµÑ|Ð¼ÐµÑÑÑ†) (Ð¾Ñ‚|Ð´Ð¾) \d{2,6}\s?(\$|USDT?|EUR|Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²|Ñ€ÑƒÐ±(Ð»ÐµÐ¹)?)', -10],
            ['Ð² (Ð½ÐµÐ´|Ð½ÐµÐ´ÐµÐ»ÑŽ|Ð´|Ð´ÐµÐ½ÑŒ|ÑÑƒÑ‚|ÑÑƒÑ‚ÐºÐ¸|Ð¼ÐµÑ|Ð¼ÐµÑÑÑ†) (Ð¾Ñ‚|Ð´Ð¾) \$\s?\d{2,6}', -10],
            ['\d{2,6}\s?(\$|USDT?|EUR|Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²|Ñ€ÑƒÐ±(Ð»ÐµÐ¹)?)? \d{2,6}\s?(\$|USDT?|EUR|Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²|Ñ€ÑƒÐ±(Ð»ÐµÐ¹)?) Ð² (Ð½ÐµÐ´|Ð½ÐµÐ´ÐµÐ»ÑŽ|Ð´|Ð´ÐµÐ½ÑŒ|ÑÑƒÑ‚|ÑÑƒÑ‚ÐºÐ¸|Ð¼ÐµÑ|Ð¼ÐµÑÑÑ†)', -10],
            ['\$?\d{2,6} \$\s?\d{2,6} Ð² (Ð½ÐµÐ´|Ð½ÐµÐ´ÐµÐ»ÑŽ|Ð´|Ð´ÐµÐ½ÑŒ|ÑÑƒÑ‚|ÑÑƒÑ‚ÐºÐ¸|Ð¼ÐµÑ|Ð¼ÐµÑÑÑ†)', -10],
            ['Ð¾Ð¿Ð»Ð°Ñ‚Ð° \d{2,6}\s?(\$|USDT?|EUR|Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²|Ñ€ÑƒÐ±(Ð»ÐµÐ¹)?)', -10],
            ['Ð¾Ð¿Ð»Ð°Ñ‚Ð° \$\s?\d{2,6}', -10],
            ['Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð° ÐºÑ€Ð¸Ð¿Ñ‚Ð°', -10],
            ['Ð¼ÐµÑÑ‚Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ñ‹', -10],
            ['Ð² (ÑÑ„ÐµÑ€Ðµ|Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸) (ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°|ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹|ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚(Ñ‹)?|crypto|Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ñ‹Ñ… (Ð²Ð°Ð»ÑŽÑ‚|Ð°ÐºÑ‚Ð¸Ð²Ð¾Ð²))', -10],
            ['P2P (trading|Ñ‚Ñ€ÐµÐ¹Ð´Ð¸Ð½Ð³(Ñƒ|Ð°|Ðµ)?)', -10],
            ['Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€Ð¾Ð² Ð²( Ð½Ð°ÑˆÑƒ| Ð½Ð¾Ð²ÑƒÑŽ)? ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ', -10],
            ['Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾ Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¼Ð¸', -10],
            ['Ñ Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ñ‹Ð¼Ð¸ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸', -10],
            ['Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°', -10],
            ['Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´Ð»Ñ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°', -10],
            ['Ð² ÑÑ„ÐµÑ€Ðµ Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ð¾Ð¹ Ð²Ð°Ð»ÑŽÑ‚Ñ‹', -10],
            ['Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´', -10],
            ['(Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚|Ñ‚Ð¾Ð»ÑŒÐºÐ¾) \d{2}\+', -10],
            ['(Ð¾Ñ‚|Ñ) \d{2} Ð»ÐµÑ‚', -10],
            ['Ð»ÑŽÐ±Ð¾Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚', -10],
            ['(Ð»ÐµÐ³ÐºÐ¾Ðµ?|Ð¼Ð¾Ð¶Ð½Ð¾|Ð½Ðµ\s?ÑÐ»Ð¾Ð¶Ð½Ð¾|Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ) ÑÐ¾Ð²Ð¼ÐµÑ‰(Ð°Ñ‚ÑŒ|Ð°ÐµÑ‚ÑÑ|ÐµÐ½Ð¸Ðµ)', -10],
            ['Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚(Ð¾Ðº|ÐºÐ°)', -10],
            ['Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°', -10],
            ['Ð´Ð¾Ñ…Ð¾Ð´(Ð¾Ð¼)? Ð¾Ñ‚', -10],
            ['Ñ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¼ Ð´Ð¾Ñ…Ð¾Ð´Ð¾Ð¼', -10],
            ['Ð´Ð¾Ñ…Ð¾Ð´ Ð² ÑÑ€ÐµÐ´Ð½ÐµÐ¼', -10],
            ['Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ðº Ð¾Ñ‚', -10],
            ['Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ðº Ð½Ð°', -10],
            ['Ñ‡Ð°ÑÐ° Ð² Ð´ÐµÐ½ÑŒ', -10],
            ['Ð´Ð»Ñ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹', -10],
            ['Ð±ÐµÑ€Ñ‘Ð¼ Ð±ÐµÐ· Ð¾Ð¿Ñ‹Ñ‚Ð°', -10],
            ['Ñ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼ Ð¸ Ð±ÐµÐ·', -10],
            ['Ð²ÑÐµÐ¼Ñƒ Ð½Ð°ÑƒÑ‡Ð¸Ð¼', -10],
            ['Ð¾Ð¿Ñ‹Ñ‚ Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½', -10],
            ['Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ðº Ð½Ð° (Ð±Ð¸Ð½Ð°Ð½Ñ|binance)', -10],
            ['Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ðº Ð² Ð¼ÐµÑÑÑ†', -10],
            ['Ð¾Ñ‚ ÑÑƒÐ¼Ð¼Ñ‹ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ', -10],
            ['ÑÑ„ÐµÑ€Ð° (ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ñ‹|ÐºÑ€Ð¸Ð¿Ñ‚Ð¾|crypto)', -10],
            ['Ð·Ð° Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹', -10],
            ['Ð¿Ð°ÑÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¶ÐµÐ»Ð°Ð½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ', -10],
            ['ÑÐ¾Ð¿Ñ€Ð¾Ð²Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¸ (Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ|Ð´Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ)', -10],
            ['Ð²ÑÐµÐ¼Ñƒ Ð¾Ð±ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ ÑÐ¾Ð¿Ñ€Ð¾Ð²Ð¾Ð¶Ð´Ð°ÐµÐ¼', -10],
            ['Ð² ÑÑ„ÐµÑ€Ðµ ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹', -10],
            ['crypto', -10],
            ['Ð½ÐµÑ‚ Ð¾Ð¿Ñ‹Ñ‚Ð° Ð½Ðµ ÑÑ‚Ñ€Ð°ÑˆÐ½Ð¾', -10],
            ['Ð¼Ñ‹ Ð²ÑÐµÐ¼Ñƒ Ð½Ð°ÑƒÑ‡Ð¸Ð¼', -10],
            ['(Ð·Ð° Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹|Ð·Ð°Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ¾Ð²Ð°Ð½Ð½Ñ‹Ð¼|Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹|Ð¿Ð¸ÑˆÐ¸ Ð¼Ð½Ðµ|Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ|Ð½Ðµ ÑÑ‚ÐµÑÐ½ÑÐµÐ¼ÑÑ|ÐºÐ¾Ð¼Ñƒ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾) \+ Ð² (Ð»Ñ|Ð»Ð¸Ñ‡ÐºÑƒ|Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ)', -10],
            ['Ð¿Ð¸ÑˆÐ¸(Ñ‚Ðµ)? \+', -10],
            ['(Ð½Ð°)?Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸(Ðµ|Ñ) \+', -10],
            ['(Ð½Ð°)?Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ \+ Ð² Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸(Ðµ|Ñ)', -10],
            ['ÐºÐ¾Ð¼Ñƒ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾ \+', -10],
            ['(Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚ÑŒ|Ð·Ð°Ð¹Ð¼ÐµÑ‚|Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚|Ð½ÑƒÐ¶Ð½Ð¾ Ð²ÑÐµÐ³Ð¾) [^\s]+( [^\s]+)?( [^\s]+)? Ñ‡Ð°ÑÐ°', -10],
            ['ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ñ… [^\s]+( [^\s]+)?( [^\s]+)? Ñ‡Ð°ÑÐ° Ð² Ð´ÐµÐ½ÑŒ', -10],
            ['(Ð´Ð¾|Ð¾Ñ‚) [^\s]+( [^\s]+)?( [^\s]+)? Ñ‡Ð°Ñ(Ñƒ|Ð°|Ð¾Ð²) Ð² Ð´ÐµÐ½ÑŒ', -10],
            ['Ñ€Ð°Ð±Ð¾Ñ‚Ð° (Ð½Ð° Ð´Ð¾Ð¼Ñƒ|Ð² Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ðµ)', -10],
            ['Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°', -10],
            ['Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð»ÑŽÐ±Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ð°', -10],
            ['Ð»ÑŽÐ´Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ (Ñ|Ð¸Ð·) Ð´Ð¾Ð¼Ð°', -10],
            ['Ð²ÑÐµÐ¼Ñƒ Ð¾Ð±ÑƒÑ‡Ð°ÐµÐ¼ Ñ Ð²Ð°Ñ Ð´ÐµÐ½ÐµÐ³ Ð½Ðµ Ð±ÐµÑ€ÐµÐ¼', -10],
            ['Ð¾Ñ‚ Ð²Ð°Ñ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ‹Ñ…Ð¾Ð´ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚', -10],
            ['Ð±Ð¾Ð½ÑƒÑ Ðº Ð´Ð¾Ñ…Ð¾Ð´Ñƒ', -10],
            ['Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½Ð° Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ', -10],
            ['Ð´Ð¾Ð²Ð¾Ð´Ð¸Ð¼ Ð´Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°', -10],
            ['ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° ÑÐ¸Ð»ÑŒÐ½Ñ‹Ñ… ÐºÐ¾Ð»Ð»ÐµÐ³ Ð¸ ÑÐºÑÐ¿ÐµÑ€Ñ‚Ð¾Ð²', -10],
            ['Ð¾Ð±Ð¼ÐµÐ½ Ñ†ÐµÐ½Ð½Ñ‹Ð¼ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼', -10],
            ['Ð±ÐµÑ€ÐµÐ¼ Ð»ÑŽÐ´ÐµÐ¹ Ñ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼ Ð¸ Ð±ÐµÐ·', -10],
            ['Ð´Ð¾Ð²Ð¾Ð´Ð¸Ð¼ Ð´Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°', -10],
            ['Ð¿Ð¾Ð²Ñ‹ÑÑŒÑ‚Ðµ ÑÐ²Ð¾Ðµ Ð±Ð»Ð°Ð³Ð¾ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ', -10],
            ['Ð½Ðµ Ð²Ñ‹Ñ…Ð¾Ð´Ñ Ð¸Ð· Ð´Ð¾Ð¼Ð°', -10],
            ['Ð½Ð¾Ð²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ¸Ñ€ÑƒÑŽÑ‰ÐµÐ¹ ÑÑ„ÐµÑ€Ðµ Ð´Ð¾Ñ…Ð¾Ð´Ð°', -10],
            ['Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾', -10],
            ['Ñ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼ Ð² ÐºÑ€Ð¸Ð¿Ñ‚Ðµ', -10],
            ['Ð´Ð»Ñ Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹', -10],
            ['Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°', -10],
            ['ÑÐ°Ð¼Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚Ðµ ÑÐ²Ð¾Ð¸Ð¼ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ð¼', -10],
            ['Ð¾Ñ‚ Ð²Ð°ÑˆÐµÐ¹ Ñ‡Ð¸ÑÑ‚Ð¾Ð¹ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»Ð¸', -10],
            ['Ð½Ð° Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ…', -10],
            ['(Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ|Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³(Ð°ÑŽ|Ð°ÐµÐ¼)) Ð²Ð°Ð¼ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¾Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ÑƒÑŽ', -10],
            ['Ñ Ð³Ð¸Ð±ÐºÐ¸Ð¼ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¼ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð¼', -10],
            ['Ð¿Ð¾ Ð¿Ð¾Ð²Ð¾Ð´Ñƒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹', -10],
            ['Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ð»ÑŽÐ±Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð¼Ð¸Ñ€Ð°', -10],
            ['Ñ€Ð°Ð±Ð¾Ñ‚Ð° ÑÐ¾ ÑÐ²Ð¾Ð¸Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²', -10],
            ['c Ð»ÑŽÐ±Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²', -10],
            ['Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ', -10],
            ['Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹', -10],
            ['Ð²ÑÐµ Ð»ÐµÐ³Ð°Ð»ÑŒÐ½Ð¾ Ð±ÐµÐ· Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚', -10],
            ['ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð°Ñ Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚ÑŒ', -10],
            ['Ð² Ð½Ð¾Ð²Ð¾Ð¼ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸', -10],
            ['Ð±ÐµÐ· Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚', -10],
            ['Ð±ÐµÐ· Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸(Ð¹|Ñ)', -10],
            ['Ñ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸', -10],
            ['Ð½Ð¾Ð²Ð¾Ðµ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒÐ½Ð¾Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ', -10],
            ['ÐµÑÑ‚ÑŒ Ñ‚ÐµÐ¼Ð° Ð±ÐµÐ»Ð°Ñ', -10],
            ['Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÑŽ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€ÑÑ‚Ð²Ð¾', -10],
            ['ÑÑ„ÐµÑ€Ðµ Crypto', -10],
            ['Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð·Ð°Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ', -10],
            ['Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ðº c Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð´Ð½Ñ', -10],
            ['Ð²Ñ‹Ð²ÐµÐ´ÐµÐ¼ Ð½Ð° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚', -10],
            ['Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ðº', -10],
            ['Ð´Ð»Ñ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð°', -10],
            ['ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²( Ð´Ð»Ñ)?( Ð½Ð°ÑˆÐµÐ¹)? ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹', -10],
            ['Ð¾Ð¿Ñ‹Ñ‚ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ', -10],
            ['Ð²ÑÐµÐ¼Ñƒ Ð½Ð°ÑƒÑ‡(Ñƒ|Ð¸Ð¼) Ð½Ð° Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ð¸', -10],
            ['Ñ‡Ð¸ÑÑ‚(Ð°Ñ|Ð¾Ð¹) Ð¿Ñ€Ð¸Ð±Ñ‹Ð»(ÑŒ|Ð¸)', -10],
            ['ÐºÐ°Ð¶Ð´Ñ‹Ð¹ ÑÐ¼Ð¾Ð¶ÐµÑ‚ ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒÑÑ Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ð¹', -10],
            ['(Ð±Ñ‹Ñ‚ÑŒ|Ð±ÑƒÐ´ÑŒ)( Ð²ÑÐµÐ³Ð´Ð°)? Ð½Ð° ÑÐ²ÑÐ·Ð¸', -10],
            ['Ð³Ð¾Ñ‚Ð¾Ð² Ð·Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ ÑƒÐ¶Ðµ ÑÐµÐ¹Ñ‡Ð°Ñ', -10],
            ['Ð¿Ð°Ñ€Ñƒ Ñ‡Ð°ÑÐ¾Ð² ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸', -10],
            ['Ð¶ÐµÐ»Ð°Ð½Ð¸Ðµ Ð·Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ', -10],
            ['ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚', -10],
            ['Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹', -10],
            ['Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ð°Ñ Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°', -10],
            ['Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾', -10],
            ['Ð½Ð° Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð²Ñ‹Ð³Ð¾Ð´Ð½Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ…', -10],
            ['ÐµÑÐ»Ð¸ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾, Ñ€Ð°ÑÑÐºÐ°Ð¶Ñƒ Ð¿Ð¾ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ', -10],
            ['ÑÐ²ÑÐ·Ðº(Ð°|Ñƒ|Ð¸|Ð¾Ðº)', -10],
            ['ÐºÑ€Ð¸5Ñ‚(Ð°|Ðµ)', -10],
            ['ÑÐ°Ð¼Ð¾Ðµ Ð½Ð¾Ð²Ð¾Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ', -10],
            ['ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ', -10],
            ['Ð¾Ð¿Ñ‹Ñ‚Ð½(Ð¾Ð¹|Ð°Ñ|ÑƒÑŽ) ÐºÐ¾Ð¼Ð°Ð½Ð´(Ðµ|Ð°|Ñƒ)', -10],
            ['Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹', -10],
            ['Ð´Ð»Ñ ÑƒÑÐ¿ÐµÑ…Ð° Ð² ÑÑ‚Ð¾Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸', -10],
            ['Ð´Ð¾Ñ…Ð¾Ð´ Ð´Ð¾ÑÑ‚Ð¸Ð³Ð°ÐµÑ‚', -10],
            ['Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ð°', -10],
            ['Ð»Ð¸ÑˆÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¾Ñ‚', -10],
            ['Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð²', -10],
            ['Ð½Ð¾Ð²Ñ‹Ðµ Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ñ‹ ÑƒÑÐ¿ÐµÑ…Ð°', -10],
            ['Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ', -10],
            ['Ð³Ñ€Ð°Ñ„Ð¸Ðº Ð¾Ð±ÑÑƒÐ¶Ð´Ð°ÐµÑ‚ÑÑ', -10],
            ['Ð¿Ñ€Ð¸ÑÑ‚Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´', -10],
            ['Ñ‚Ð²Ð¾Ð¸ Ð´Ñ€ÑƒÐ·ÑŒÑ ÑÐ»ÐµÐ´ÑÑ‚ Ð·Ð° Ñ€Ð¾ÑÑ‚Ð¾Ð¼ Ð±Ð¸Ñ‚ÐºÐ¾Ð¸Ð½Ð°', -10],
            ['ÑƒÐ¶Ðµ Ð·Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚', -10],
            ['Ð° Ñ‚Ñ‹ Ð²ÑÐµ ÐµÑ‰Ðµ', -10],
            ['Ð¾Ñ‚ (Ð·Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ñ‹|Ð°Ð²Ð°Ð½ÑÐ°) Ð´Ð¾ (Ð·Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ñ‹|Ð°Ð²Ð°Ð½ÑÐ°)', -10],
            ['Ð°Ð¼Ð±Ð¸Ñ†Ð¸Ð¾Ð·Ð½(Ñ‹Ð¹|Ð¾Ð³Ð¾|Ñ‹Ñ…) (Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°?|Ð»ÑŽÐ´ÐµÐ¹)', -10],
            ['Ð½Ð¾Ð²(Ð¾Ð¹|Ð°Ñ) ÑÑ„ÐµÑ€(Ñ‹|Ð°) Ð´ÐµÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸', -10],
            ['Ð¿Ñ€ÐµÐ´Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÑÐº(Ð¸Ðµ|Ð¸Ð¹|Ð¾Ð³Ð¾) Ñ‚Ð°Ð»Ð°Ð½Ñ‚(Ñ‹|Ð°|)', -10],
            ['Ñ‚Ð²Ð¾ÑŽ Ð¸Ð¼Ð¿ÐµÑ€Ð¸ÑŽ', -10],
            ['Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸', -10],
            ['ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½(Ð¾Ð³Ð¾|Ñ‹Ð¹) Ð±Ð¸Ð·Ð½ÐµÑ(Ð°|)', -10],
            ['Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¼ÐµÑ‡Ñ‚Ñ‹ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ', -10],
//            ['', -10],
//            ['', -10],
//            ['', -10],
//            ['', -10],
//            ['', -10],
        ];
        if (isset($this->badWordStat) && !isset($this->badWordStat->stat)) {
            foreach ($badWordSequences as $badWordSequenceData) {
                $this->badWordStat->stat[$badWordSequenceData[0]] = 0;
            }
        }

        $totalRate = 0;
        foreach ($badWordSequences as $badWordSequenceData) {
            list($badWordPhrase, $rate) = $badWordSequenceData;
            //var_dump(self::splitWords($badWordPhrase));
            if (self::isWordSubsequence($words, self::splitWords($badWordPhrase))) {
                echo "\tMatched \"{$badWordPhrase}\"\n";
                $totalRate += $rate;
                if (isset($this->badWordStat)) {
                    $this->badWordStat->stat[$badWordPhrase]++;
                }
            }
        }
        echo "rateBadWords: " . $totalRate . "\n";
        $this->rate += $totalRate;
    }

    private function rateMixedLetters(): void
    {
        $rate = 0;
        $words = self::canonizeWords(self::extractWords((string) $this->message->text));
        foreach ($words as $word) {
            $hasRussian = false;
            $hasEnglish = false;
            $hasSpecial = false;
            if (preg_match('/[Ð°-Ñ]/ui', $word)) { // has Russian
                $hasRussian = true;
            }
            if (preg_match('/[a-z]/ui', $word)) { // has English
                $hasEnglish = true;
            }
            if (preg_match('/[á¸É‘Î¿È¯]/ui', $word)) { // has Umlaut
                $hasSpecial = true;
            }
            // var_dump($word, $hasRussian, $hasEnglish, $hasSpecial);
            if ($hasRussian && $hasEnglish && preg_match('/^[a-z]{2,}[Ð°-Ñ]+$/ui', $word)) { // exclude words like "IDÑˆÐ½Ð¸Ðº"
                continue;
            }
            if (($hasRussian && $hasEnglish) || ($hasRussian && $hasSpecial) || ($hasEnglish && $hasSpecial)) {
                $rate -= 1;
                echo "\tMixed letters in \"{$word}\"\n";
            }
        }
        echo "rateMixedLetters: " . $rate . "\n";
        $this->rate += $rate;
    }

    private function rateMaskedDigits(): void
    {
        $rate = 0;
        $words = self::canonizeWords(self::extractWords((string) $this->message->text));
        foreach ($words as $word) {
            if (preg_match('/^(\d+[oÐ¾]+)+\d*$/ui', $word)) {
                $rate -= 25;
                echo "\tMasked digits in \"{$word}\"\n";
            }
        }
        echo "rateMaskedDigits: " . $rate . "\n";
        $this->rate += $rate;
    }

    private static function isWordSubsequence(array $words, array $wordsSequence): bool
    {
        $words = self::canonizeWords($words);
        $wordsSequence = self::canonizeWords($wordsSequence);
        if (count($wordsSequence) == 0) {
            return false;
        }

//        var_dump(implode(' ', $words));
//        var_dump('/(?:^|\s)' . self::enrichRegExp(implode(' ', $wordsSequence)) . '(?:$|\s)/u');
        return (bool) preg_match('/(?:^|\s)' . self::enrichRegExp(implode(' ', $wordsSequence)) . '(?:$|\s)/u', implode(' ', $words));
//        $j = 0;
//        for ($i = 0; $i < count($words); $i++) {
//            if (preg_match("/^{$wordsSequence[$j]}$/u", $words[$i])) {
//                $j++;
//            } else {
//                $j = 0;
//            }
//            if ($j == count($wordsSequence)) {
//                return true;
//            }
//        }
//
//        return false;
    }

    private static function enrichRegExp(string $regexp): string
    {
        $enriches = [
            'Ð°' => '(Ð°|a|4|á¸|É‘)',
            'Ð±' => '(Ð±|6)',
            'Ð²' => '(Ð²|b)',
            'Ð³' => '(Ð³|r)',
            'Ð´' => '(Ð´|d)',
            'Ðµ' => '(Ðµ|e)',
            'Ð·' => '(Ð·|3)',
            'Ð¸' => '(Ð¸|u)',
            'Ðº' => '(Ðº|k)',
            'Ð¼' => '(Ð¼|m)',
            'Ð¾' => '(Ð¾|o|0|Î¿|È¯)',
            'Ñ€' => '(Ñ€|p)',
            'Ñ' => '(Ñ|c)',
            'Ñ‚' => '(Ñ‚|t)',
            'Ñƒ' => '(Ñƒ|y)',
            'Ñ…' => '(Ñ…|x)',
            'a' => '(a|Ð°)',
            'b' => '(b|Ð²)',
            'c' => '(c|Ñ)',
            'e' => '(e|Ðµ)',
            'g' => '(g|Ð³)',
            'i' => '(i|1)',
            'k' => '(k|Ðº)',
            'l' => '(l|1)',
            'o' => '(o|Ð¾|0)',
            'p' => '(p|Ñ€)',
            'x' => '(x|Ñ…)',
            'y' => '(y|Ñƒ)',
        ];

        return str_replace(array_keys($enriches), array_values($enriches), $regexp);
    }

    private static function canonizeWords(array $words): array
    {
        // ðŸ’² 18âž•
        for ($i = 0; $i < count($words); $i++) {
            $words[$i] = mb_strtolower($words[$i]);
            $words[$i] = str_replace('Ñ‘', 'Ðµ', $words[$i]);
        }
        return $words;
    }

    private function getMessagesCountFromUser(string $fromId, int $chatId, int $beforeMessageId): int
    {
        $stmt = $this->pdo->prepare("SELECT COUNT(*) `count` FROM `messages` WHERE `group_id` = :group_id AND `from_id` = :from_id AND id < :message_id");
        $stmt->execute([
            'group_id' => $chatId,
            'from_id' => $fromId,
            'message_id' => $beforeMessageId,
        ]);
        $count = $stmt->fetchColumn();
        $stmt->closeCursor();
        return (int) $count;
    }

    private function getDateOfFirstUserMessage(string $fromId, int $chatId): ?int
    {
        $stmt = $this->pdo->prepare("SELECT `date_unixtime` FROM `messages` WHERE `group_id` = :group_id AND `from_id` = :from_id ORDER BY `id` LIMIT 1");
        $stmt->execute([
            'group_id' => $chatId,
            'from_id' => $fromId,
        ]);
        $date_unixtime = $stmt->fetchColumn();
//        var_dump($date_unixtime);die;
        $stmt->closeCursor();
        return $date_unixtime ? (int) $date_unixtime : null;
    }

    private static function splitWords(string $phrase): array
    {
        $words = preg_split('/\s+/ui', $phrase, -1, PREG_SPLIT_NO_EMPTY);
//        echo "\nWords: "; var_dump($words);die;
        return $words;
    }

    private static function extractWords(string $text): array
    {
//        preg_match_all('/[Ð°-ÑÑ‘a-z$0-9+]+/ui', $text, $m);
        preg_match_all('/((?>\pL\pM*)|[0-9$+])+/u', $text, $m);
        return $m[0];
//        var_dump($m[0]);die;
//        $words = preg_split('/[\s.,()!@#$%^&*\[\]"\'\\\\\/]+/ui', $text, -1, PREG_SPLIT_NO_EMPTY);
//        echo "\nWords: "; var_dump($words);die;
    }
}
